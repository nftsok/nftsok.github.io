<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>NFT SOK</title>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="../../css/element-ui@2.13.0-theme-chalk-index.css">
    <link rel="stylesheet" type="text/css" href="../../css/common.css">
</head>
<body>
<div id="app" class="ml20 pr20 main-content">
    <el-row>
        <el-col :span="24">
            <el-breadcrumb separator-class="el-icon-arrow-right" class="title">
                <el-breadcrumb-item :to="{ path: '/' }">NFT Accidents</el-breadcrumb-item>
            </el-breadcrumb>
        </el-col>
    </el-row>
    <el-divider content-position="left"></el-divider>
    <el-row class="mt10">
        <template>
            <el-table
                    ref="multipleTable"
                    stripe
                    border
                    v-loading="loading"
                    :data="tableData"
                    :default-sort = "{prop: 'date', order: 'descending'}"
                    >
                <el-table-column type="expand">
                        <template slot-scope="props">
                            <el-form label-position="top" inline class="demo-table-expand" style="margin-left: 20px; width: 60%;">
                                <!-- <el-form-item label="Quick Summary" class="no-wrap">
                                    <span>{{ props.row.summary }}</span>
                                </el-form-item>
                                <el-form-item label="Details of the Exploit" class="no-wrap">
                                    <span class="custom-span">{{ props.row.details }}</span>
                                </el-form-item> -->
                                <template v-if="props.row.title" v-for="(title, titleIndex) in props.row.title">
                                    <el-form-item :label="title" class="no-wrap">
                                        <template v-for="(content, contentIndex) in props.row.title_content[titleIndex]" v-if="content !== ''">
                                            <span class="vertical-align custom-span">
                                                <template v-if="isHttpLink(content)">
                                                    <el-link :key="contentIndex" :href="content" target="_blank" class="vertical-align no-clor" type="primary" :underline="false">{{ content }}</el-link>
                                                </template>
                                                <template v-else>
                                                    {{ content }}
                                                </template>
                                            </span>
                                        </template>
                                    </el-form-item>
                                </template>
                                <el-form-item v-if="props.row.description" label="Description" class="no-wrap">
                                    <span  class="custom-span">{{ props.row.description }}</span>
                                </el-form-item>
                                <el-form-item label="Block Data Reference" class="no-wrap" v-if="props.row.reference_url && props.row.reference_url.length > 0">
                                    <span class="vertical-align">{{ props.row.reference }}</span>
                                    <el-link v-for="url in props.row.reference_url" :href="url" target="_blank" class="vertical-align no-clor"  type="primary" :underline="false">{{ url }}</el-link>
                                </el-form-item>
                                <el-form-item label="linktree" class="no-wrap" v-if="props.row.linktree">
                                    <el-link target="_blank" type="primary" :underline="false">{{ props.row.linktree }}</el-link>
                                </el-form-item>
                            </el-form>
                        </template>
                </el-table-column>
                <!-- <el-table-column label="Date" prop="date" align="left" :sortable="customSort_date"> -->
                <el-table-column label="Date" prop="date" :sortable="customSort_date" align="center">
                </el-table-column>


                <el-table-column  label="Chain" prop="chain" align="center"></el-table-column>

                <el-table-column  label="Target" prop="target" align="center"></el-table-column>
                <!-- <el-table-column label="Description" prop="desc"  width="200" align="center"></el-table-column> -->
                <el-table-column label="Loss" prop="loss"  sortable align="center">
                    <template slot-scope="props">
                        <!-- <el-tag :type="getTagType(props.row.loss)">{{ formatMoney(props.row.loss) }}</el-tag> -->

                        <el-tag :type="getTagType(props.row.loss)" class="fixed-tag">{{ formatMoney_aft(props.row.loss,props.row.loss_unit) }}</el-tag>
                    </template>
                </el-table-column>
                <el-table-column label="Category" prop="attack" align="center" sortable> 
                    <template slot-scope="props">
                        <el-tag :type="getAttackTagType(props.row.attack)" class="fixed-tag-attack">{{ (props.row.attack) }}</el-tag>
                    </template>
                </el-table-column>
                <el-table-column label="Layer" prop="layer" align="center" sortable> 
                    <template slot-scope="props">
                        <el-tag :type="getLayerTagType(props.row.layer)" class="fixed-tag-layer">{{ (props.row.layer) }}</el-tag>
                    </template>
                </el-table-column>
<!--                 <el-table-column label="Reference Link" prop="link" align="center">
                    <template v-slot="scope"> 
                        <el-link @click="Click_link(scope.row)" target="_blank" class="buttonText"  type="primary" :underline="false">link</el-link>
                    </template>
                </el-table-column> -->
            </el-table>
        </template>
    </el-row>
    <!-- pagination:{goto:"jump",pagesize:"/page",total:"total:{total} line",pageClassifier:"page"} -->
    <!-- pagination:{goto:"前往",pagesize:"条/页",total:"共 {total} 条",pageClassifier:"页"} -->
    <el-row class="mt20 mb20">
        <el-pagination
                background
                layout="total, sizes, prev, pager, next, jumper"
                :total="dataTotal"
                :current-page="page.currentPage"
                :page-sizes="[10, 20, 30, 40, 50, 100, 200, 300]"
                :page-size="page.pageSize"
                @size-change="handleSizeChange"
                @current-change="handleCurrentChange">
        </el-pagination>
    </el-row>
</div>
<script src="../../js/jquery.3.2.1.min.js"></script>
<script src="../../js/vue-v2.6.11.js"></script>
<script src="../../js/element-ui@2.13.0-index.js"></script>
<script src="../../js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<!-- <script src="../../js/common.js"></script> -->
<!-- <script src="../../js/apiUrl.js"></script> -->
<script src="../../js/md5.js"></script>
<script>
    let vueApplication = new Vue({
        el: "#app",
        directives: {
            'el-select-loadmore': {
                bind(el, binding) {
                    // 获取element-ui定义好的scroll盒子
                    const SELECTWRAP_DOM = el.querySelector('.el-select-dropdown .el-select-dropdown__wrap');
                    SELECTWRAP_DOM.addEventListener('scroll', function () {
                        /**
                         * scrollHeight 获取元素内容高度(只读)
                         * scrollTop 获取或者设置元素的偏移值,常用于, 计算滚动条的位置, 当一个元素的容器没有产生垂直方向的滚动条, 那它的scrollTop的值默认为0.
                         * clientHeight 读取元素的可见高度(只读)
                         * 如果元素滚动到底, 下面等式返回true, 没有则返回false:
                         * ele.scrollHeight - ele.scrollTop === ele.clientHeight;
                         */
                        const condition = this.scrollHeight - this.scrollTop <= this.clientHeight;
                        if (condition) {
                            binding.value();
                        }
                    });
                }
            }
        },
        data() {
            return {
                loading: true,//遮罩
                //page相关参数
                list: [],
                page: {
                    pageSize: 10,
                    currentPage: 1,
                },
                //表格数据
                tableData: [

                ],
                //数据总数
                dataTotal: 29,
            }
        },
        methods: {
            //通用关闭弹窗,传入ref
            cancelPop(ref) {
                if (ref) {
                    this.$refs[ref].doClose();
                }
            },
            //获取敏感信息扫描结果列表
            getTableData() {
                // read json => list
                // this.tabledata = []
            },
            //重置当前页
            searchTableData() {
                this.page.pageSize = 10;
                this.page.currentPage = 1;
                // this.getTableData();
                this.loadDataFromJson();
            },
            //获取当前页pageSize
            handleSizeChange(val) {
                this.page.currentPage = 1;
                this.page.pageSize = val;
                // this.getTableData();//重新请求表格数据
                this.loadDataFromJson();
            },
            //获取当前页currentPage
            handleCurrentChange(val) {
                this.page.currentPage = val;
                // this.getTableData();//重新请求表格数据
                this.loadDataFromJson();
            },
            //点击链接
            Click_link(row) {
	            window.open(row.link, '_blank');
            },  
            // 日期排序
            customSort_date(o1, o2) {
                const parts1 = o1.date.split('-');
                if (parts1.length === 3) {
                const year1 = parts1[0];
                const month1 = parts1[1].padStart(2, '0');
                const day1 = parts1[2].padStart(2, '0');
                const date1_pre = `${year1}-${month1}-${day1}`;
                }
                const parts2 = o2.date.split('-');
                if (parts2.length === 3) {
                    const year2 = parts2[0];
                    const month2 = parts2[1].padStart(2, '0');
                    const day2 = parts2[2].padStart(2, '0');
                    const date2_pre = `${year2}-${month2}-${day2}`;
                }

                const date1 = new Date(date1_pre);
                const date2 = new Date(date2_pre);
                // 修改原始props
                o1.date = date1;
                o2.date = date2;
                return date1 - date2;
            },
            formatDate(dateString) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                const year = parts[0];
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                return `${year}-${month}-${day}`;
                }
                return dateString; // 返回原始日期字符串，如果格式不符合
            },
            // 金额格式化
            formatMoney(row, column, cellValue) {
                // 且每3位以,分隔
                return "$" + cellValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
               
            },
            // 金额type
            getTagType(loss) {
                if (loss == 0) {
                    return 'info'; // 或其他默认类型
                } else if (loss <= 5000) {
                    return 'success';
                } else if (loss <= 10000 ){
                    return 'warning'; 
                }else{
                    return 'danger';

                }
            },
            formatMoney_aft(loss, loss_unit) {
                // {'OP', 'USD', 'TMT', 'USDT', 'BNB', 'ETH'}
                // 且每3位以,分隔
                if (loss == 0) {
                    return "-";
                }
                if (loss_unit == "USD"){
                    return "$" + loss.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                }else if (loss_unit == "ETH"){
                    return loss.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + " ETH";
                }else if (loss_unit == "BNB"){
                    return loss.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + " BNB";
                }else if (loss_unit == "USDT"){
                    return loss.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + " USDT";
                }else if (loss_unit == "TMT"){
                    return loss.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + " TMT";
                }else if (loss_unit == "OP"){
                    return loss.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + " OP";
                }
            },
            getAttackTagType(attack) {
                const keywordsToType = {
                    "Rug Pull": 'success',
                    "Social Media": 'warning',
                    "Website Exploitation": 'warning',
                    "Reentrancy Attack": 'danger',
                    "Phishing attack": 'success',
                    "Key Compromise": 'danger',
                    "Improper Business Logic": 'danger',
                    "Flashloan-based": 'danger',
                    "Contract Vulnerability": 'danger',
                    "Conditional Expressing": 'danger',
                    "Assert-related": 'danger'
                };

                for (const keyword in keywordsToType) {
                    if (attack.toLowerCase().includes(keyword.toLowerCase())) {
                        return keywordsToType[keyword];
                    }
                }

                // 如果没有匹配到关键词，默认返回 'info' 或其他适合的类型
                return 'info';
            },
            getLayerTagType(layer) {
                if (layer == "Contract layer") {
                return 'success';
                } else if (layer == "Market layer") {
                return 'warning'; // 或其他适合的类型
                } else if (layer == "Auxiliary layer"){
                return 'danger';
                }
                return 'info'; // 或其他默认类型
            },
            loadDataFromJson() {
                // axios.get('data.json',) // 请根据你的 JSON 文件路径进行调整
                //     .then(response => {
                //         this.tableData = response.data; // 将获取到的 JSON 数据分配给 dataTable
                //         this.dataTotal = response.data.length; // 获取记录总数
                //     })
                //     .catch(error => {
                //     console.error('Error loading JSON data: ', error);
                //     });
                axios.get('data.json',) // 请根据你的 JSON 文件路径进行调整
                    .then(response => {
                        this.list = response.data; // 将获取到的 JSON 数据分配给 dataTable
                        this.dataTotal = response.data.length; // 获取记录总数
                        this.tableData = this.getNeedArr(this.list, this.page.pageSize)[this.page.currentPage - 1] ; //当前页的表格数据
                    })
                    .catch(error => {
                    console.error('Error loading JSON data: ', error);
                    });

                // fetch('data.json')
                // .then(response => response.json()) // 解析JSON响应
                // .then(data => {
                //     // 在这里处理加载的JSON数据
                //     console.log(data); // 你可以使用console.log来查看数据
                //     this.tableData = data;
                // })
                // .catch(error => {
                //     console.error('Error loading JSON:', error);
                // });
            },
            getNeedArr(array, size) {       //获取所需指定长度分割的数组;参数1为用于分割的总数组,参数2为分割数组后每个小数组的长度
                const length = array.length;
                //判断不是数组，或者size没有设置，size小于1，就返回空数组
                if (!length || !size || size < 1) {
                    return [];
                }
                
                let index = 0; //用来表示切割元素的范围start
                let resIndex = 0; //用来递增表示输出数组的下标

                //根据length和size算出输出数组的长度，并且创建它。
                let result = new Array(Math.ceil(length / size));
                //进行循环
                while (index < length) {
                    //循环过程中设置result[0]和result[1]的值。该值根据array.slice切割得到。
                    result[resIndex++] = array.slice(index, (index += size));
                }
                //输出到新数组
                return result;
            },
	    isHttpLink(str) {
                return str.startsWith('http://') || str.startsWith('https://');
            },
        },
        mounted() {
            // this.getTableData();//获取表格数据
            this.loadDataFromJson();
            const that = this;
            that.loading = false;
        }
    })
</script>
</body>
</html>

<style>
    .no-wrap {
        white-space: nowrap;
        width: 200px; /* 根据您的需要调整宽度 */
        margin-right: 10px; /* 设置间距 */
    }
    .custom-span {
        margin-right: 0;
        margin-bottom: 0;
        width: auto;
        white-space: normal;
        display: block; /* 设置为块级元素 */
    }
    .vertical-align {
        display: block; /* 将元素放置在单独的行 */
        margin-bottom: 5px; /* 设置垂直间距 */
    }
    .no-color {
        color: inherit; /* 继承父元素的文本颜色 */
    }
    .fixed-tag {
        width: 110px; /* 设置标签宽度 */
        height: 30px; /* 设置标签高度 */
        line-height: 30px; /* 垂直居中文本 */
        text-align: center; /* 水平居中文本 */
    }
    .fixed-tag-attack {
        width: 200px; /* 设置标签宽度 */
        height: 30px; /* 设置标签高度 */
        line-height: 30px; /* 垂直居中文本 */
        text-align: center; /* 水平居中文本 */
    }

    .fixed-tag-layer {
        width: 110px; /* 设置标签宽度 */
        height: 30px; /* 设置标签高度 */
        line-height: 30px; /* 垂直居中文本 */
        text-align: center; /* 水平居中文本 */
    }

</style>
